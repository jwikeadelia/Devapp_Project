name: Deploy Devapp to Minikube (Podman)

on:
  push:
    branches: [ "master" ]

jobs:
  build-and-test:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Test Environment
      run: |
        echo "✅ Checking Podman installation..."
        podman --version
        
        # Matikan error stop sementara
        $ErrorActionPreference = 'Continue'
        minikube status
        $ErrorActionPreference = 'Stop'

    - name: Build Images with Podman
      run: |
        echo "Building Backend..."
        # Pastikan nama image ini SAMA dengan yang ada di file k8s/03-backend.yaml
        podman build -t devapp_project_backend:latest ./backend
        
        echo "Building Frontend..."
        # Pastikan nama image ini SAMA dengan yang ada di file k8s/04-frontend.yaml
        podman build -t devapp_project_frontend:latest ./frontend
        
        # Verifikasi image ada
        podman images | findstr devapp

    - name: Test Container (Singkat)
      run: |
        echo "Testing Backend Container Start..."
        podman run -d --name test-backend -p 5001:5000 devapp_project_backend:latest
        
        sleep 5
        
        if (podman ps --filter "name=test-backend" --format "{{.Names}}") { 
            echo "✅ Container is running" 
        } else { 
            echo "❌ Container failed to start"
            podman logs test-backend
            exit 1 
        }
        
        podman stop test-backend
        podman rm test-backend

  deploy-to-minikube:
    needs: build-and-test
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Prepare Minikube & Load Images
      run: |
        # --- PERBAIKAN LOGIKA START MINIKUBE (Windows PowerShell) ---
        $ErrorActionPreference = 'Continue' # Jangan stop jika command berikut gagal
        minikube status
        
        # Jika exit code tidak 0 (berarti mati/error), nyalakan minikube
        if ($LASTEXITCODE -ne 0) {
            Write-Host "Minikube mati/belum ada. Menyalakan..."
            minikube start --driver=podman
        }
        $ErrorActionPreference = 'Stop' # Kembalikan ke mode normal
        # ------------------------------------------------------------

        echo "Saving images to tar..."
        podman save -o backend.tar devapp_project_backend:latest
        podman save -o frontend.tar devapp_project_frontend:latest

        echo "Loading images into Minikube..."
        minikube image load backend.tar
        minikube image load frontend.tar

        echo "Cleaning up tar files..."
        rm backend.tar
        rm frontend.tar

    - name: Apply Kubernetes Manifests
      run: |
        # Apply semua config
        kubectl apply -f k8s/00-namespace.yaml
        kubectl apply -f k8s/01-config-secrets.yaml
        kubectl apply -f k8s/02-database.yaml
        
        # Apply App
        kubectl apply -f k8s/03-backend.yaml
        kubectl apply -f k8s/04-frontend.yaml
        
        # Apply Monitoring (Opsional - Jika error, comment baris ini)
        # kubectl apply -f k8s/monitoring/

    - name: Refresh Deployment
      run: |
        echo "Restarting deployments to pick up new images..."
        kubectl rollout restart deployment backend-deployment -n devapp
        kubectl rollout restart deployment frontend-deployment -n devapp
        
        echo "Waiting for rollout..."
        kubectl rollout status deployment/backend-deployment -n devapp --timeout=120s
        kubectl rollout status deployment/frontend-deployment -n devapp --timeout=120s

    - name: Verification
      run: |
        echo "=== DEPLOYMENT STATUS ==="
        kubectl get pods -n devapp
        kubectl get services -n devapp