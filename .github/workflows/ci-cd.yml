name: Deploy Devapp to Minikube (Podman)

on:
  push:
    branches: [ "master" ] # Sesuaikan dengan branch utama Anda

jobs:
  build-and-test:
    # Wajib self-hosted agar bisa akses Podman di laptop
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    # Contoh testing sederhana (Opsional, sesuaikan dengan project Node.js Anda)
    - name: Test Environment
      run: |
        echo "✅ Checking Podman installation..."
        podman --version
        echo "✅ Checking Minikube status..."
        minikube status

    - name: Build Images with Podman
      run: |
        # Build Backend
        echo "Building Backend..."
        podman build -t devapp_project_backend:latest ./backend
        
        # Build Frontend
        echo "Building Frontend..."
        podman build -t devapp_project_frontend:latest ./frontend
        
        # Verifikasi image ada
        podman images | findstr devapp

    - name: Test Container (Singkat)
      run: |
        # Menjalankan container sebentar untuk memastikan tidak crash saat start
        echo "Testing Backend Container Start..."
        podman run -d --name test-backend -p 5001:5000 devapp_project_backend:latest
        
        # Tunggu 5 detik
        sleep 5
        
        # Cek apakah masih jalan
        if (podman ps --filter "name=test-backend" --format "{{.Names}}") { 
            echo "✅ Container is running" 
        } else { 
            echo "❌ Container failed to start"
            exit 1 
        }
        
        # Bersih-bersih
        podman stop test-backend
        podman rm test-backend

  deploy-to-minikube:
    needs: build-and-test
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Prepare Minikube & Load Images
      run: |
        # 1. Pastikan Minikube jalan (jika belum, start)
        # Kita gunakan '||' agar jika sudah jalan, dia tidak error
        minikube status || minikube start --driver=podman

        # 2. Save Image dari Podman ke File (Teknik paling stabil untuk Windows)
        echo "Saving images to tar..."
        podman save -o backend.tar devapp_project_backend:latest
        podman save -o frontend.tar devapp_project_frontend:latest

        # 3. Load Image ke Minikube
        echo "Loading images into Minikube..."
        minikube image load backend.tar
        minikube image load frontend.tar

        # 4. Hapus file tar (hemat space)
        rm backend.tar
        rm frontend.tar

    - name: Apply Kubernetes Manifests
      run: |
        # Terapkan semua file di folder k8s
        kubectl apply -f k8s/00-namespace.yaml
        kubectl apply -f k8s/01-config-secrets.yaml
        kubectl apply -f k8s/02-database.yaml
        kubectl apply -f k8s/03-backend.yaml
        kubectl apply -f k8s/04-frontend.yaml
        
        # Deploy monitoring (opsional)
        kubectl apply -f k8s/monitoring/

    - name: Refresh Deployment
      run: |
        # Paksa restart pod agar menggunakan image terbaru yang baru di-load
        kubectl rollout restart deployment backend-deployment -n devapp
        kubectl rollout restart deployment frontend-deployment -n devapp
        
        # Tunggu rollout selesai (timeout 2 menit)
        kubectl rollout status deployment/backend-deployment -n devapp --timeout=120s
        kubectl rollout status deployment/frontend-deployment -n devapp --timeout=120s

    - name: Verification
      run: |
        echo "=== DEPLOYMENT STATUS ==="
        kubectl get pods -n devapp
        kubectl get services -n devapp